<%- include('../admin/adminLayout/header.ejs')%>
<%- include('../admin/adminLayout/navbar.ejs')%>



<style>
  .img-fluid{
    width: 200px;
  }
  .option-value{
    width: 300px;
    height: 33px;
    border-radius: 5px;
  }
  .input-value{
    width: 300px;
    border-radius: 5px;
  }
  
</style>

<!-- saideNaveBar -->


<body class="g-sidenav-show  bg-gray-200">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3   bg-gradient-dark" id="sidenav-main">
    <div class="sidenav-header" style="margin: 15px;">
      <i class="fas fa-times p-3 cursor-pointer text-white opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href="#" target="_blank"></a>
      <img src="/assets/img/my_Logo.png" class="navbar-brand-img h-100" alt="main_logo">
      <span class="ms-1 font-weight-bold text-white">Energy Cart</span>
    </a>
    </div>
    <hr class="horizontal light mt-0 mb-2">
    <!-- <div class="collapse navbar-collapse  w-auto  max-height-vh-100" id="sidenav-collapse-main"> -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/admin/adminHome">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">dashboard</i>
            </div>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-users">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">group</i>
            </div>
            <span class="nav-link-text ms-1">Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white active bg-gradient-primary" href="/admin/view-product">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">inventory_2</i>
            </div>
            <span class="nav-link-text ms-1">Product</span>
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-brand">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">branding_watermark</i>
            </div> 
            <span class="nav-link-text ms-1">Brand</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-category">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">category</i>
            </div>
            <span class="nav-link-text ms-1">Category</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/view-orders">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">wysiwyg</i>
            </div>
            <span class="nav-link-text ms-1">Orders</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-white font-weight-bolder opacity-8">Account pages</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="./pages/profile.html">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">person</i>
            </div>
            <span class="nav-link-text ms-1">Profile</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white " href="/admin/logout">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">logout</i>
            </div>
            <span class="nav-link-text ms-1">Log out</span>
          </a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link text-white " href="./pages/sign-up.html">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons opacity-10">assignment</i>
            </div>
            <span class="nav-link-text ms-1">Sign Up</span>
          </a>
        </li> -->
      </ul>
    <!-- </div>
    <div class="sidenav-footer position-absolute w-100 bottom-0 ">
      <div class="mx-3">
        <a class="btn bg-gradient-primary mt-4 w-100" href="https://www.creative-tim.com/product/material-dashboard-pro?ref=sidebarfree" type="button">Upgrade to pro</a>
      </div>
    </div> -->
  </aside>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
    


<!-- endSaidNavBar -->

<div class="container-fluid py-4">
    <div class="row">
      <div class="col-12">
        <div class="card my-4">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
              <h6 class="text-white text-capitalize ps-3"><%=title%></h6>
            </div>
          </div>
          <div class="card-body px-0 pb-2">
            <div class="container-fluid">
              <form class="forms-sample" action="/admin/edit-product" enctype="multipart/form-data" method="post" >
                <div class="row">
                    <div class="col-md-6 py-4">
                        <div class="form-group">
                            <div class="form-label rounded">Product Name</div>
                            <input class="input-value" type="text" value="<%= productData.name%>" name="productName" placeholder="Product Name" id="productName">
                          </div>
                          <span id="productNameError" class="error-message text-danger"></span>
                      </div>
                      
                      <div class="col-md-6 py-4">
                        <div class="form-group">
                            <div class="form-label rounded">Category Name</div>
                            <select class="option-value"  id="categoryName" name="category">
                                <!-- <option disabled selected>Choose Category</option> -->
                                  <% category.forEach(cat => { %>
                                    <option class="option" value="<%=cat._id %>"><%=cat.categoryName%></option>
                                    <% }); %>
                                  </select>
                                </div>
                                <div id="categoryNameError" class="error-message text-danger"></div>
                      </div>
                      <div class="col-md-6 py-4">
                        <div class="form-group">
                            <div class="form-label rounded">Brand</div>
                            <select class="option-value"  id="brand" name="brand">
                              <!-- <option disabled selected>Choose Category</option> -->
                                <% brandData.forEach(brand => { %>
                                  <option class="option" value="<%= brand._id %>"><%=brand.brandName%></option>
                                  <% }); %>
                                </select>
                              </div>
                              <span id="brandNameError" class="error-message text-danger"></span>
                      </div>
                      <div class="col-md-6 py-4">
                        <div class="form-group">
                            <div class="form-label rounded">Quantity</div>
                            <input class="input-value" type="number" value="<%=productData.qty%>" name="qty" placeholder="Quantity" id="quantity">
                          </div>
                          <span id="quantityError" class="error-message text-danger"></span>
                      </div>
                      <div class="row">
                        <div class="col md-6 py-4">
                          <div class="form-group">
                              <div class="form-label rounded">Specification</div>
                              <input class="input-value" type="text" value="<%=productData.description%>" name="description" placeholder="description">
                            </div>
                            <span id="specificationError" class="error-message text-danger"></span>
                        </div>
               
                      <div class="col-md-6 py-4">
                        <div class="form-group">
                            <div class="form-label rounded">Price</div>
                            <input class="input-value" type="text" value="<%=productData.price%>" name="price" placeholder="Price" id="price">
                          </div>
                          <span id="priceError" class="error-message text-danger"></span>
                      </div>
                    </div>

                    
                    <div class="row">
                      <!-- Old image preview container -->
                      <div class="col-md-6 py-4 old-image-preview-container">
                        <!-- Image previews for old images will be dynamically added here -->
                        <% if(productData.image.length > 0) { %>
                          <div class="form-label rounded">Old Images</div>
                          <% productData.image.forEach(img => { %>
                            <div class="image-container" data-image="<%= img %>">
                              <img src="/adminAssets/images/<%= img %>" alt="Old Image" style="width: 100px;" class="img-fluid imgView">
                              <button type="button" class="remove-button" onclick="removeImage(event)" remove>Remove</button>
                            </div>
                          <% }); %>
                        <% } %>
                      </div>
                    
                      <!-- New image preview container -->
                      <div class="col-md-6 py-4 new-image-preview-container">
                        <div class="form-group">
                          <div class="form-label rounded">New Images</div>
                          <input type="file" name="image" id="newImage" multiple accept="image/*" onchange="handleImageChange(event)">
                        </div>
                    
                        <!-- Image preview container for new images -->
                        <div class="row">
                          <div class="col-md-3 py-4">
                            <!-- Image previews for new images will be dynamically added here -->
                          </div>
                        </div>
                      </div>
                    </div>
                                              
                      <div class="form-check md-6 py-4">
                        <div class="form-label rounded">Action</div>
                        <input class="form-check-input"  type="radio" name="is_active" value="1" <% if(productData.is_active==true){%> checked <%}%> >
                        <label class="form-check-label" for="flexRadioDefault1">List</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="is_active" value="0" <% if(productData.is_active==false){%> id="flexRadioDefault2" checked <%}%> >
                        <label class="form-check-label"  for="flexRadioDefault2">Unlist</label>
                      </div>
                  </div>
                      <div class="row">
                        <div class="col md-3 py-4">
                          <input type="hidden" name="id" value="<%=productData._id %>">
                          <button type="submit" class="btn btn-primary">Update</button>
                        </div>
                      </div>
                </div>
            </form>

        
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>



<!-- link for ajax -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- CDN link for sweetalert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>





<script>
  
  function removeImage(event) {
      // const imageContainer = event.target.parentNode;
      const imageContainer = event.target.closest('.image-container');
      const imageName = imageContainer.getAttribute('data-image');
      // const imageName = document.getElementById('#image')

        // Remove the image container from the DOM immediately
        // imageContainer.parentNode.removeChild(imageContainer);
      
        console.log('imageName',imageName);
      // Send an AJAX request to the server to handle the removal
      $.ajax({
        type: 'POST',
        url: '/admin/remove-image',
        contentType:'application/json',
        data: JSON.stringify({ imageName: imageName }),
        success: function (response) {
          
          console.log('Success: Old image removed',response);

          Swal.fire({
          icon: 'success',
          title: 'Image Removed',
          text: 'The old image has been successfully removed.',
        });

          // Remove the image container from the DOM
          imageContainer.parentNode.removeChild(imageContainer);
        },
        error: function (xhr, status,error) {
          // Handle errors if necessary
          console.error(error);
          console.error('Status:', status);
          console.error('Response:', xhr.responseText);

          Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'An error occurred while removing the image.',
        });

        }

      });
    }
</script>



<script>

document.addEventListener('DOMContentLoaded', function () {
  const inputImage = document.getElementById('newImage');
  const oldImageContainer = document.querySelector('.old-image-preview-container');
  const newImageContainer = document.querySelector('.new-image-preview-container');

  // Event delegation for dynamically added elements
  document.body.addEventListener('change', function (event) {
    if (event.target.id === 'newImage') {
      handleImageChange(event);
    }
  });

  document.body.addEventListener('mouseover', function (event) {
    const removeButton = event.target.closest('.image-container')?.querySelector('.remove-button');
    if (removeButton) {
      removeButton.style.display = 'block';
    }
  });

  document.body.addEventListener('mouseout', function (event) {
    const removeButton = event.target.closest('.image-container')?.querySelector('.remove-button');
    if (removeButton) {
      removeButton.style.display = 'none';
    }
  });


  async function validateProductName() {
    const productName = document.getElementById('productName').value.trim();
    const productNameError = document.getElementById('productNameError');
    productNameError.textContent = '';

    if (productName.length < 3 && productName==='') {
      productNameError.textContent = "Product name must be at least 3 characters long.";
      return false;
    }
    return true;
  }

  async function validateCategoryName() {
    const categoryName = document.getElementById('categoryName').value.trim();
    const categoryNameError = document.getElementById('categoryNameError');
    categoryNameError.textContent = '';

    if (categoryName.length < 3) {
      categoryNameError.textContent = "Category name must be at least 3 characters long.";
      return false;
    }
    return true;
  }

  async function validatePrice() {
    const price = document.getElementById('price').value.trim();
    const priceError = document.getElementById('priceError');
    priceError.textContent = '';

    if (price === '' || isNaN(price) || parseFloat(price) <= 0) {
      priceError.textContent = "Price must be a non-negative numeric value.";
      return false;
    }
    return true;
  }

  async function validateQuantity() {
    const quantity = document.getElementById('quantity').value.trim();
    const quantityError = document.getElementById('quantityError');
    quantityError.textContent = '';

    if (isNaN(quantity) || parseFloat(quantity) < 1) {
      quantityError.textContent = "Quantity must be a numeric value of at least 1.";
      return false;
    }
    return true;
  }




  //----------------------- Image Preview-----------------------//

  function handleImageChange(event) {
    const newImagePreviewContainer = document.querySelector('.new-image-preview-container .col-md-3');

    Array.from(inputImage.files).forEach(function (file) {
      const reader = new FileReader();

      reader.onload = function () {
        const imagePreview = createImagePreview(reader.result, file);
        newImagePreviewContainer.appendChild(imagePreview);
      };

      reader.readAsDataURL(file);
    });
  }

  function createImagePreview(src, file) {
    const imagePreview = document.createElement('div');
    imagePreview.classList.add('image-container'); // Add image container class
    imagePreview.innerHTML = `
      <img src="${src}" alt="Image Preview" class="img-fluid imgView">
      <button type="button" class="remove-button">Remove</button>`;

    const removeButton = imagePreview.querySelector('.remove-button');
    removeButton.addEventListener('click', function () {
      imagePreview.remove();
      // Remove corresponding file from input
      const dt = new DataTransfer();
      Array.from(inputImage.files).forEach(function (existingFile) {
        if (existingFile !== file) {
          dt.items.add(existingFile);
        }
      });
      inputImage.files = dt.files;
    });

    return imagePreview;
  }

  // Add event listener for form submission
  document.querySelector('form').addEventListener('submit', async function (event) {
    // Validate fields before submitting the form
    const isValidProductName = await validateProductName();
    const isValidCategoryName = await validateCategoryName();
    const isValidPrice = await validatePrice();
    const isValidQuantity = await validateQuantity();

    if (!isValidProductName || !isValidCategoryName || !isValidPrice || !isValidQuantity) {
      // Optionally, display an alert or message to the user
      Swal.fire({
        icon: 'error',
        title: 'Validation Error',
        text: 'Please fix the errors in the form.',
      });

      // Prevent form submission since validation failed
      event.preventDefault();
    } else {
      // Display SweetAlert confirmation
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: 'You are about to submit the form.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, submit it!',
        cancelButtonText: 'No, cancel!',
      });

      if (!result.isConfirmed) {
        // If the user clicks "No," prevent form submission
        event.preventDefault();
      }
    }
  });

  // Other functions (validateProductName, validateCategoryName, validatePrice, validateQuantity) go here
});

function viewImage(event) {
  var imgViews = document.getElementsByClassName('imgView');

  for (let i = 0; i < imgViews.length; i++) {
    imgViews[i].src = URL.createObjectURL(event.target.files[i]);
  }
}

</script>



  <%-include('../admin/adminLayout/footer.ejs')%>